<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>產品管理平台</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 載入 Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        .scrollbar-hidden::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hidden {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .bg-primary { background-color: #10b981; }
        .text-primary { color: #10b981; }
        .border-primary { border-color: #10b981; }
        .nav-btn { background-color: transparent !important; color: #4b5563 !important; border: none !important; transition: all 0.3s ease !important; }
        .nav-btn:hover { background-color: #10b981 !important; color: #ffffff !important; }
        .nav-btn.active { background-color: #10b981 !important; color: #ffffff !important; font-weight: 600 !important; }
        .table-row:hover { background-color: #10b981 !important; color: #ffffff !important; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <!-- 移動菜單按鈕 -->
    <div class="md:hidden bg-white shadow-lg p-4 flex justify-between items-center sticky top-0 z-40">
        <h1 class="text-xl font-bold text-gray-800">產品管理平台</h1>
        <button onclick="toggleMobileSidebar()" class="p-2 hover:bg-gray-100 rounded-lg">
            <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>
        </button>
    </div>

    <!-- 主容器 -->
    <div class="flex flex-1 overflow-hidden">
        <!-- 側邊欄導航 -->
        <div id="sidebar" class="hidden md:flex w-full md:w-64 bg-white shadow-xl md:h-screen md:sticky md:top-0 flex-col transition-all duration-300 fixed inset-0 z-30 md:relative md:z-auto">
            <!-- 移動設備關閉按鈕 -->
            <div class="md:hidden flex justify-between items-center p-4 border-b">
                <h1 class="text-xl font-bold text-gray-800">產品管理平台</h1>
                <button onclick="toggleMobileSidebar()" class="p-2 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="x" class="w-6 h-6 text-gray-700"></i>
                </button>
            </div>

            <div class="hidden md:block p-6 border-b">
                <h1 class="text-2xl font-bold text-gray-800">產品管理平台</h1>
                <p class="text-sm text-gray-500 mt-1" id="user-info">user-info</p>
            </div>

            <nav class="flex flex-col p-4 space-y-2 overflow-y-auto">
                <button onclick="changePage('dashboard'); toggleMobileSidebar()" class="nav-btn group flex items-center p-3 text-gray-700 rounded-lg hover:bg-indigo-50 hover:text-primary transition duration-150 active-dashboard w-full justify-start">
                    <i data-lucide="layout-grid" class="w-5 h-5 mr-3"></i>
                    儀表板
                </button>
                <button onclick="changePage('orders'); toggleMobileSidebar()" class="nav-btn group flex items-center p-3 text-gray-700 rounded-lg hover:bg-indigo-50 hover:text-primary transition duration-150 active-orders w-full justify-start">
                    <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i>
                    訂單管理
                </button>
                <button onclick="changePage('products'); toggleMobileSidebar()" class="nav-btn group flex items-center p-3 text-gray-700 rounded-lg hover:bg-indigo-50 hover:text-primary transition duration-150 active-products w-full justify-start">
                    <i data-lucide="package" class="w-5 h-5 mr-3"></i>
                    規格登錄
                </button>
                <button onclick="changePage('customers'); toggleMobileSidebar()" class="nav-btn group flex items-center p-3 text-gray-700 rounded-lg hover:bg-indigo-50 hover:text-primary transition duration-150 active-customers w-full justify-start">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    客戶管理
                </button>
                <button onclick="changePage('contacts'); toggleMobileSidebar()" class="nav-btn group flex items-center p-3 text-gray-700 rounded-lg hover:bg-indigo-50 hover:text-primary transition duration-150 active-contacts w-full justify-start">
                    <i data-lucide="contact" class="w-5 h-5 mr-3"></i>
                    人員建立
                </button>
            </nav>
        </div>

        <!-- 主要內容區 -->
        <main class="flex-1 overflow-y-auto scrollbar-hidden w-full">
            <div id="app-content" class="p-4 sm:p-6 md:p-8">
                <div class="flex justify-center items-center h-full">
                    <p class="text-gray-500">正在載入應用程式...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 模態視窗 -->
    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden justify-center items-center z-50">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-lg mx-4 max-h-screen overflow-y-auto">
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api';
        const USER_ID = 'default-user';

        let currentPage = 'dashboard';
        let products = [];
        let orders = [];
        let customers = [];
        let contacts = [];

        // 切換移動設備側邊欄
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
            setTimeout(() => lucide.createIcons(), 0);
        }

        // 點擊邊界外時關閉側邊欄
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.querySelector('[data-lucide="menu"]');
            if (sidebar && !sidebar.contains(e.target) && !menuBtn?.closest('button').contains(e.target)) {
                if (window.innerWidth < 768) {
                    sidebar.classList.add('hidden');
                }
            }
        });

        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: { 
                        'Content-Type': 'application/json', 
                        'x-user-id': USER_ID, 
                        ...options.headers 
                    },
                    ...options
                });
                
                // 檢查響應狀態
                if (!response.ok) {
                    const text = await response.text();
                    console.error(`API 錯誤 ${response.status}:`, text);
                    return { data: [] };
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API 請求錯誤:', error);
                return { data: [] };
            }
        }

        async function loadAllData() {
            const productsRes = await apiRequest('/products');
            const ordersRes = await apiRequest('/orders');
            const customersRes = await apiRequest('/customers');
            const contactsRes = await apiRequest('/contacts');

            products = productsRes.data || [];
            orders = ordersRes.data || [];
            customers = customersRes.data || [];
            contacts = contactsRes.data || [];

            console.log('數據加載完成:', { products: products.length, orders: orders.length, customers: customers.length, contacts: contacts.length });
            changePage('dashboard');
        }

        function showMessage(type, message) {
            const box = document.createElement('div');
            box.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white z-50 transition-all ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            box.textContent = message;
            document.body.appendChild(box);
            setTimeout(() => box.remove(), 3000);
        }

        function openModal(contentHTML) {
            const modalContainer = document.getElementById('modal-container');
            document.getElementById('modal-content').innerHTML = contentHTML;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
        }

        function closeModal() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.add('hidden');
            modalContainer.classList.remove('flex');
        }

        document.getElementById('modal-container').addEventListener('click', (e) => {
            if (e.target.id === 'modal-container') {
                closeModal();
            }
        });

        window.changePage = (page) => {
            currentPage = page;
            const navButtons = document.querySelectorAll('.nav-btn');
            
            navButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(`active-${page}`)) {
                    btn.classList.add('active');
                }
            });

            const contentDiv = document.getElementById('app-content');
            contentDiv.innerHTML = '<div class="flex justify-center items-center h-64"><p class="text-gray-500">加載中...</p></div>';

            switch (page) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'orders':
                    renderOrdersPage();
                    break;
                case 'products':
                    renderProductsPage();
                    break;
                case 'customers':
                    renderCustomersPage();
                    break;
                case 'contacts':
                    renderContactsPage();
                    break;
            }
            // 等待 DOM 更新後初始化圖標
            setTimeout(() => {
                lucide.createIcons();
            }, 0);
        };

        function formatDate(isoString) {
            if (!isoString) return '-';
            if (isoString.match(/^\d{4}-\d{2}-\d{2}$/)) return isoString;
            try { return new Date(isoString).toISOString().split('T')[0]; } catch { return isoString; }
        }

        function daysUntil(dateString) {
            if (!dateString) return null;
            const oneDay = 24 * 60 * 60 * 1000;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(dateString);
            targetDate.setHours(0, 0, 0, 0);
            if (isNaN(targetDate)) return null;
            return Math.round((targetDate.getTime() - today.getTime()) / oneDay);
        }

        function renderDashboard() {
            const expiringProducts = products
                .filter(p => {
                    const days = daysUntil(p.expirationDate);
                    return days !== null && days <= 30 && days >= 0;
                })
                .sort((a, b) => daysUntil(a.expirationDate) - daysUntil(b.expirationDate));

            // 計算統計數據
            const totalRevenue = orders.reduce((sum, o) => sum + (parseFloat(o.unitPrice) * parseFloat(o.quantity) || 0), 0);
            const totalOrders = orders.length;
            const totalProducts = products.length;
            const totalCustomers = customers.length;
            const avgOrderValue = totalOrders > 0 ? (totalRevenue / totalOrders).toFixed(2) : 0;

            const html = `
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-4xl font-bold text-gray-800">儀表板</h2>
                        <p class="text-gray-500 text-sm mt-1">December 2025</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="changePage('orders')" class="bg-white border border-gray-300 text-gray-700 font-medium py-2 px-6 rounded-lg hover:bg-gray-50 transition">此月份</button>
                        <button onclick="changePage('dashboard')" class="bg-green-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-green-700 transition">檢視報告</button>
                    </div>
                </div>

                <!-- KPI 卡片 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8">
                    <!-- 訂單收入 -->
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 sm:p-6 rounded-xl shadow-lg border border-green-200">
                        <div class="flex justify-between items-start gap-3">
                            <div class="flex-1 min-w-0">
                                <p class="text-xs sm:text-sm font-medium text-gray-600 mb-2">訂單收入</p>
                                <p class="text-lg sm:text-2xl lg:text-3xl font-bold text-gray-900 truncate">NT$${totalRevenue.toLocaleString('en-US', {maximumFractionDigits: 0})}</p>
                                <p class="text-xs text-green-600 mt-1 sm:mt-2 flex items-center"><i data-lucide="trending-up" class="w-3 h-3 mr-1"></i>+12.5%</p>
                            </div>
                            <div class="bg-green-500 p-2 sm:p-3 rounded-lg flex-shrink-0">
                                <i data-lucide="dollar-sign" class="w-5 h-5 sm:w-6 sm:h-6 text-white"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 總訂單 -->
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 sm:p-6 rounded-xl shadow-lg border border-red-200">
                        <div class="flex justify-between items-start gap-3">
                            <div class="flex-1 min-w-0">
                                <p class="text-xs sm:text-sm font-medium text-gray-600 mb-2">總訂單數</p>
                                <p class="text-lg sm:text-2xl lg:text-3xl font-bold text-gray-900">${totalOrders}</p>
                                <p class="text-xs text-red-600 mt-1 sm:mt-2 flex items-center"><i data-lucide="trending-up" class="w-3 h-3 mr-1"></i>+8.2%</p>
                            </div>
                            <div class="bg-red-500 p-2 sm:p-3 rounded-lg flex-shrink-0">
                                <i data-lucide="shopping-cart" class="w-5 h-5 sm:w-6 sm:h-6 text-white"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 平均訂單值 -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 sm:p-6 rounded-xl shadow-lg border border-blue-200">
                        <div class="flex justify-between items-start gap-3">
                            <div class="flex-1 min-w-0">
                                <p class="text-xs sm:text-sm font-medium text-gray-600 mb-2">平均訂單值</p>
                                <p class="text-lg sm:text-2xl lg:text-3xl font-bold text-gray-900 truncate">NT$${avgOrderValue}</p>
                                <p class="text-xs text-blue-600 mt-1 sm:mt-2 flex items-center"><i data-lucide="trending-up" class="w-3 h-3 mr-1"></i>+15.3%</p>
                            </div>
                            <div class="bg-blue-500 p-2 sm:p-3 rounded-lg flex-shrink-0">
                                <i data-lucide="bar-chart-3" class="w-5 h-5 sm:w-6 sm:h-6 text-white"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 總產品/客戶 -->
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 sm:p-6 rounded-xl shadow-lg border border-purple-200">
                        <div class="flex justify-between items-start gap-3">
                            <div class="flex-1 min-w-0">
                                <p class="text-xs sm:text-sm font-medium text-gray-600 mb-2">管理資源</p>
                                <p class="text-lg sm:text-2xl lg:text-3xl font-bold text-gray-900">${totalProducts + totalCustomers}</p>
                                <p class="text-xs text-purple-600 mt-1 sm:mt-2 truncate">
                                    <i data-lucide="package" class="w-3 h-3 mr-1 inline"></i>${totalProducts}/${totalCustomers}
                                </p>
                            </div>
                            <div class="bg-purple-500 p-2 sm:p-3 rounded-lg flex-shrink-0">
                                <i data-lucide="layers" class="w-5 h-5 sm:w-6 sm:h-6 text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 下半部分：即將到期和概況 -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
                    <!-- 左側：即將到期產品 (2 列寬) -->
                    <div class="lg:col-span-2 bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="alert-triangle" class="w-4 h-4 sm:w-5 sm:h-5 mr-2 text-red-500"></i>
                            即將到期的產品
                        </h3>
                        ${expiringProducts.length === 0 ? '<p class="text-gray-500 py-4 sm:py-8 text-center text-sm">目前沒有產品即將到期。</p>' : `
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-xs sm:text-sm">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="px-2 sm:px-4 py-2 text-left font-semibold text-gray-600">產品</th>
                                            <th class="px-2 sm:px-4 py-2 text-left font-semibold text-gray-600 hidden sm:table-cell">到期</th>
                                            <th class="px-2 sm:px-4 py-2 text-left font-semibold text-gray-600">天數</th>
                                            <th class="px-2 sm:px-4 py-2 text-left font-semibold text-gray-600">庫存</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${expiringProducts.slice(0, 5).map(p => `
                                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                                <td class="px-2 sm:px-4 py-2 font-medium text-gray-900">${p.name.substring(0, 10)}</td>
                                                <td class="px-2 sm:px-4 py-2 text-gray-600 hidden sm:table-cell">${formatDate(p.expirationDate)}</td>
                                                <td class="px-2 sm:px-4 py-2">
                                                    <span class="inline-flex items-center px-2 py-0.5 sm:px-3 sm:py-1 rounded-full text-xs font-semibold ${daysUntil(p.expirationDate) <= 7 ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800'}">
                                                        ${daysUntil(p.expirationDate)}
                                                    </span>
                                                </td>
                                                <td class="px-2 sm:px-4 py-2 text-gray-600">${p.quantity}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>

                    <!-- 右側：概況面板 -->
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4">
                            <i data-lucide="building-2" class="w-4 h-4 sm:w-5 sm:h-5 mr-2 inline"></i>
                            <span class="hidden sm:inline">系統概況</span><span class="sm:hidden">概況</span>
                        </h3>
                        <div class="space-y-3 sm:space-y-4">
                            <div class="flex justify-between items-center pb-3 sm:pb-4 border-b border-gray-200">
                                <span class="text-xs sm:text-sm text-gray-600">產品</span>
                                <span class="text-lg sm:text-2xl font-bold text-gray-900">${totalProducts}</span>
                            </div>
                            <div class="flex justify-between items-center pb-3 sm:pb-4 border-b border-gray-200">
                                <span class="text-xs sm:text-sm text-gray-600">訂單</span>
                                <span class="text-lg sm:text-2xl font-bold text-gray-900">${totalOrders}</span>
                            </div>
                            <div class="flex justify-between items-center pb-3 sm:pb-4 border-b border-gray-200">
                                <span class="text-xs sm:text-sm text-gray-600">客戶</span>
                                <span class="text-lg sm:text-2xl font-bold text-gray-900">${totalCustomers}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs sm:text-sm text-gray-600">人員</span>
                                <span class="text-lg sm:text-2xl font-bold text-gray-900">${contacts.length}</span>
                            </div>
                            <button onclick="changePage('orders')" class="w-full mt-4 sm:mt-6 bg-green-600 hover:bg-green-700 text-white font-medium py-2 rounded-lg transition text-sm sm:text-base">
                                查看訂單
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = html;
        }

        function renderOrdersPage(searchTerm = '') {
            const filtered = orders.filter(o =>
                o.productName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                o.serialNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (o.customerName || '').toLowerCase().includes(searchTerm.toLowerCase())
            );

            const html = `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <button onclick="toggleMobileSidebar()" class="md:hidden p-2 hover:bg-gray-100 rounded-lg">
                            <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>
                        </button>
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">產品訂單管理</h2>
                    </div>
                    <button onclick="showOrderForm()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm sm:text-base"><i data-lucide="plus" class="w-5 h-5 mr-1 inline"></i><span class="hidden sm:inline">新增訂單</span><span class="sm:hidden">新增</span></button>
                </div>
                <div class="mb-4 flex space-x-2">
                    <input type="text" id="order-search" oninput="renderOrdersPage(this.value)" placeholder="按產品名稱、序號或客戶名稱搜尋..." class="flex-1 p-3 border border-gray-300 rounded-lg">
                    <button onclick="exportOrdersToCsv()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="file-text" class="w-5 h-5 mr-1 inline"></i>產生報價單</button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">訂單列表 (${filtered.length} 筆)</h3>
                    <div class="overflow-x-auto">
                        ${filtered.length === 0 ? '<p class="text-gray-500 p-4 text-center">無訂單資料。</p>' : `
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50"><tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">產品名稱</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">序號</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">客戶</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">單價</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">個數</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">總價</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                                </tr></thead>
                                <tbody>
                                    ${filtered.map(order => `
                                        <tr class="table-row border-b border-gray-100">
                                            <td class="px-6 py-3 text-sm text-gray-900">${order.productName}</td>
                                            <td class="px-6 py-3 text-sm text-gray-600">${order.serialNumber}</td>
                                            <td class="px-6 py-3 text-sm text-gray-600">${order.customerName}</td>
                                            <td class="px-6 py-3 text-sm text-gray-600">$${order.unitPrice?.toFixed(2) || 0}</td>
                                            <td class="px-6 py-3 text-sm text-gray-600">${order.quantity}</td>
                                            <td class="px-6 py-3 text-sm font-medium text-gray-900">$${(order.unitPrice * order.quantity).toFixed(2)}</td>
                                            <td class="px-6 py-3 text-sm space-x-2"> 
                                                <button onclick="showOrderForm('${order.id}')" class="text-blue-600 hover:text-blue-800 mx-1" title="編輯">
                                                    <i class="fa-solid fa-pen-to-square"></i>
                                                </button>
                                                
                                                <button onclick="deleteOrder('${order.id}')" class="text-red-600 hover:text-red-800 mx-1" title="刪除">
                                                    <i class="fa-solid fa-trash-can"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = html;
        }

        window.showOrderForm = (id = null) => {
            const order = orders.find(o => o.id === id) || {};
            const customerOptions = customers.map(c => `<option value="${c.name}" ${order.customerName === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            const productOptions = products.map(p => `<option value="${p.name}" ${order.productName === p.name ? 'selected' : ''}>${p.name}</option>`).join('');
            
            const modal = `
                <h3 class="text-2xl font-bold mb-4">${id ? '編輯訂單' : '新增訂單'}</h3>
                <form onsubmit="handleOrderSubmit(event, '${id || ''}')" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">產品名稱</label>
                    <select id="productName" required class="mt-1 block w-full p-2 border border-gray-300 rounded"><option>請選擇產品</option>${productOptions}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700">產品序號</label>
                    <input type="text" id="serialNumber" value="${order.serialNumber || ''}" placeholder="產品序號" required class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">售價</label>
                    <input type="number" id="unitPrice" value="${order.unitPrice || ''}" placeholder="售價" required step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">個數</label>
                    <input type="number" id="quantity" value="${order.quantity || 1}" placeholder="個數" required class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">開始日期</label>
                    <input type="date" id="startDate" value="${formatDate(order.startDate) || formatDate(new Date())}" required class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">結束日期</label>
                    <input type="date" id="endDate" value="${formatDate(order.endDate) || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">客戶名稱</label>
                    <select id="customerName" required class="mt-1 block w-full p-2 border border-gray-300 rounded"><option>請選擇客戶</option>${customerOptions}</select></div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">取消</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">${id ? '保存修改' : '新增訂單'}</button>
                    </div>
                </form>
            `;
            openModal(modal);
        };

        window.handleOrderSubmit = async (e, id) => {
            e.preventDefault();
            const data = {
                productName: document.getElementById('productName').value,
                serialNumber: document.getElementById('serialNumber').value,
                unitPrice: parseFloat(document.getElementById('unitPrice').value),
                quantity: parseInt(document.getElementById('quantity').value),
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                customerName: document.getElementById('customerName').value,
            };
            
            const method = id ? 'PUT' : 'POST';
            const endpoint = id ? `/orders/${id}` : '/orders';
            await apiRequest(endpoint, { method, body: JSON.stringify(data) });
            showMessage('success', id ? '更新成功' : '新增成功');
            closeModal();
            loadAllData();
        };

        window.deleteOrder = async (id) => {
            if (!confirm('確定要刪除嗎？')) return;
            await apiRequest(`/orders/${id}`, { method: 'DELETE' });
            showMessage('success', '刪除成功');
            loadAllData();
        };

        window.exportOrdersToCsv = () => {
            if (orders.length === 0) {
                showMessage('error', '沒有訂單資料');
                return;
            }
            const headers = ["訂單ID", "產品名稱", "產品序號", "客戶名稱", "單價", "個數", "總價"];
            let csv = headers.join(',') + '\n';
            orders.forEach(order => {
                csv += [order.id, order.productName, order.serialNumber, order.customerName, order.unitPrice.toFixed(2), order.quantity, (order.unitPrice * order.quantity).toFixed(2)].join(',') + '\n';
            });
            const blob = new Blob([`\ufeff${csv}`], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Order_${formatDate(new Date())}.csv`;
            link.click();
        };

        function renderProductsPage(searchTerm = '') {
            const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
            
            const html = `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <button onclick="toggleMobileSidebar()" class="md:hidden p-2 hover:bg-gray-100 rounded-lg">
                            <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>
                        </button>
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">產品規格登錄</h2>
                    </div>
                    <button onclick="showProductForm()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm sm:text-base"><i data-lucide="plus" class="w-5 h-5 mr-1 inline"></i><span class="hidden sm:inline">新增規格</span><span class="sm:hidden">新增</span></button>
                </div>
                <div class="flex items-center gap-2 mb-4">
                    <input type="text" id="product-search" placeholder="輸入產品名稱..." 
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    
                    <button onclick="renderProductsPage(document.getElementById('product-search').value)" 
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg whitespace-nowrap">
                        查詢
                    </button>
                    
                    <button onclick="document.getElementById('product-search').value=''; renderProductsPage('')" 
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg whitespace-nowrap">
                        清除
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                    <h3 class="text-xl font-semibold mb-4">產品規格列表 (${filtered.length} 筆)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">名稱</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成本價</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">售價</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">個數</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">到期日</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                            </tr></thead>
                            <tbody>
                                ${filtered.map(p => `
                                    <tr class="table-row border-b border-gray-100">
                                        <td class="px-6 py-3 text-sm text-gray-900 font-medium">${p.name}</td>
                                        <td class="px-6 py-3 text-sm text-gray-600">$${p.costPrice?.toFixed(2) || 0}</td>
                                        <td class="px-6 py-3 text-sm text-gray-600">$${p.sellingPrice?.toFixed(2) || 0}</td>
                                        <td class="px-6 py-3 text-sm text-gray-600">${p.quantity}</td>
                                        <td class="px-6 py-3 text-sm text-gray-600">${formatDate(p.expirationDate)}</td>
                                        <td class="px-6 py-3 text-sm space-x-2">
                                            <button onclick="showProductForm('${p.id}')" class="text-green-600 hover:text-green-900 mx-2" title="編輯"><i class="fas fa-pen-to-square"></i></button>
                                            <button onclick="deleteProduct('${p.id}')" class="text-red-600 hover:text-red-900 mx-2" title="刪除"><i class="fas fa-trash-can"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = html;
        }

        window.showProductForm = (id = null) => {
            const product = products.find(p => p.id === id) || {};
            const modal = `
                <h3 class="text-2xl font-bold mb-4">${id ? '編輯產品規格' : '新增產品規格'}</h3>
                <form onsubmit="handleProductSubmit(event, '${id || ''}')" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">名稱</label>
                    <input type="text" id="name" value="${product.name || ''}" placeholder="產品名稱" required class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">成本價</label>
                    <input type="number" id="costPrice" value="${product.costPrice || ''}" placeholder="成本價" required step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">售價</label>
                    <input type="number" id="sellingPrice" value="${product.sellingPrice || ''}" placeholder="售價" required step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">個數</label>
                    <input type="number" id="quantity" value="${product.quantity || 0}" placeholder="個數" required min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">到期日期</label>
                    <input type="date" id="expirationDate" value="${formatDate(product.expirationDate) || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">取消</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">${id ? '保存修改' : '新增規格'}</button>
                    </div>
                </form>
            `;
            openModal(modal);
        };

        window.handleProductSubmit = async (e, id) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('name').value,
                costPrice: parseFloat(document.getElementById('costPrice').value),
                sellingPrice: parseFloat(document.getElementById('sellingPrice').value),
                quantity: parseInt(document.getElementById('quantity').value),
                expirationDate: document.getElementById('expirationDate').value,
            };
            
            const method = id ? 'PUT' : 'POST';
            const endpoint = id ? `/products/${id}` : '/products';
            await apiRequest(endpoint, { method, body: JSON.stringify(data) });
            showMessage('success', id ? '更新成功' : '新增成功');
            closeModal();
            loadAllData();
        };

        window.deleteProduct = async (id) => {
            if (!confirm('確定要刪除嗎？')) return;
            await apiRequest(`/products/${id}`, { method: 'DELETE' });
            showMessage('success', '刪除成功');
            loadAllData();
        };

        function renderCustomersPage(searchTerm = '') {
            const filtered = customers.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));
            
            const html = `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <button onclick="toggleMobileSidebar()" class="md:hidden p-2 hover:bg-gray-100 rounded-lg">
                            <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>
                        </button>
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">客戶管理</h2>
                    </div>
                    <button onclick="showCustomerForm()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm sm:text-base"><i data-lucide="plus" class="w-5 h-5 mr-1 inline"></i><span class="hidden sm:inline">新增客戶</span><span class="sm:hidden">新增</span></button>
                </div>
                
                <div class="flex items-center gap-2 mb-4">
                    <input type="text" id="customer-search" placeholder="按客戶名稱搜尋..." class="flex-1 p-3 border border-gray-300 rounded-lg">                 
                    <button onclick="renderCustomersPage(document.getElementById('customer-search').value)" 
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg whitespace-nowrap">
                        查詢
                    </button>
                    
                    <button onclick="document.getElementById('customer-search').value=''; renderCustomersPage('')" 
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg whitespace-nowrap">
                        清除
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                    <h3 class="text-xl font-semibold mb-4">客戶列表 (${filtered.length} 筆)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">名稱</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">聯絡人</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">電話</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">郵件</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                            </tr></thead>
                            <tbody>
                                ${filtered.map(c => `
                                    <tr class="table-row border-b border-gray-100">
                                        <td class="px-6 py-3 text-sm text-gray-900 font-medium">${c.name}</td>
                                        <td class="px-6 py-3 text-sm text-gray-600">${c.contactPerson}</td>
                                        <td class="px-6 py-3 text-sm text-gray-600">${c.phone}</td>
                                        <td class="px-6 py-3 text-sm text-gray-600">${c.email}</td>
                                        <td class="px-6 py-3 text-sm space-x-2">
                                            <button onclick="showCustomerForm('${c.id}')" class="text-green-600 hover:text-green-900 mx-2" title="編輯"><i class="fas fa-pen-to-square"></i></button>
                                            <button onclick="deleteCustomer('${c.id}')" class="text-red-600 hover:text-red-900 mx-2" title="刪除"><i class="fas fa-trash-can"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = html;
        }

        window.showCustomerForm = (id = null) => {
            const customer = customers.find(c => c.id === id) || {};
            const modal = `
                <h3 class="text-2xl font-bold mb-4">${id ? '編輯客戶' : '新增客戶'}</h3>
                <form onsubmit="handleCustomerSubmit(event, '${id || ''}')" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">名稱</label>
                    <input type="text" id="name" value="${customer.name || ''}" placeholder="客戶名稱" required class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">聯絡人</label>
                    <input type="text" id="contactPerson" value="${customer.contactPerson || ''}" placeholder="聯絡人" required class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">電話</label>
                    <input type="text" id="phone" value="${customer.phone || ''}" placeholder="電話" class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">郵件</label>
                    <input type="email" id="email" value="${customer.email || ''}" placeholder="郵件" class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">取消</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">${id ? '保存修改' : '新增客戶'}</button>
                    </div>
                </form>
            `;
            openModal(modal);
        };

        window.handleCustomerSubmit = async (e, id) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('name').value,
                contactPerson: document.getElementById('contactPerson').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
            };
            
            const method = id ? 'PUT' : 'POST';
            const endpoint = id ? `/customers/${id}` : '/customers';
            await apiRequest(endpoint, { method, body: JSON.stringify(data) });
            showMessage('success', id ? '更新成功' : '新增成功');
            closeModal();
            loadAllData();
        };

        window.deleteCustomer = async (id) => {
            if (!confirm('確定要刪除嗎？')) return;
            await apiRequest(`/customers/${id}`, { method: 'DELETE' });
            showMessage('success', '刪除成功');
            loadAllData();
        };

        function renderContactsPage(searchTerm = '') {
            const filtered = contacts.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));
            
            const html = `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <button onclick="toggleMobileSidebar()" class="md:hidden p-2 hover:bg-gray-100 rounded-lg">
                            <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>
                        </button>
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">內部聯絡人建立</h2>
                    </div>
                    <button onclick="showContactForm()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm sm:text-base"><i data-lucide="plus" class="w-5 h-5 mr-1 inline"></i><span class="hidden sm:inline">新增聯絡人</span><span class="sm:hidden">新增</span></button>
                </div>
                <div class="flex items-center gap-2 mb-4">
                    <input type="text" id="contact-search" placeholder="按姓名或部門搜尋..." class="flex-1 p-3 border border-gray-300 rounded-lg">
                    <button onclick="renderContactsPage(document.getElementById('contact-search').value)" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg whitespace-nowrap">查詢</button>
                    <button onclick="document.getElementById('contact-search').value=''; renderContactsPage('')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg whitespace-nowrap">清除</button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                    <h3 class="text-xl font-semibold mb-4">聯絡人列表 (${filtered.length} 筆)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">姓名</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">部門</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">電話</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">郵件</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                            </tr></thead>
                            <tbody>
                                ${filtered.map(c => `
                                    <tr class="table-row border-b border-gray-100">
                                        <td class="px-6 py-3 text-sm text-gray-900 font-medium">${c.name}</td>
                                        <td class="px-6 py-3 text-sm text-gray-600">${c.department}</td>
                                        <td class="px-6 py-3 text-sm text-gray-600">${c.phone}</td>
                                        <td class="px-6 py-3 text-sm text-gray-600">${c.email}</td>
                                        <td class="px-6 py-3 text-sm space-x-2">
                                            <button onclick="showContactForm('${c.id}')" class="text-green-600 hover:text-green-900 mx-2" title="編輯"><i class="fas fa-pen-to-square"></i></button>
                                            <button onclick="deleteContact('${c.id}')" class="text-red-600 hover:text-red-900 mx-2" title="刪除"><i class="fas fa-trash-can"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = html;
        }

        window.showContactForm = (id = null) => {
            const contact = contacts.find(c => c.id === id) || {};
            const modal = `
                <h3 class="text-2xl font-bold mb-4">${id ? '編輯聯絡人' : '新增聯絡人'}</h3>
                <form onsubmit="handleContactSubmit(event, '${id || ''}')" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">姓名</label>
                    <input type="text" id="name" value="${contact.name || ''}" placeholder="姓名" required class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">部門</label>
                    <input type="text" id="department" value="${contact.department || ''}" placeholder="部門" required class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">電話</label>
                    <input type="text" id="phone" value="${contact.phone || ''}" placeholder="電話/分機" class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">郵件</label>
                    <input type="email" id="email" value="${contact.email || ''}" placeholder="郵件" class="mt-1 block w-full p-2 border border-gray-300 rounded"></div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">取消</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">${id ? '保存修改' : '新增聯絡人'}</button>
                    </div>
                </form>
            `;
            openModal(modal);
        };

        window.handleContactSubmit = async (e, id) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('name').value,
                department: document.getElementById('department').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
            };
            
            const method = id ? 'PUT' : 'POST';
            const endpoint = id ? `/contacts/${id}` : '/contacts';
            await apiRequest(endpoint, { method, body: JSON.stringify(data) });
            showMessage('success', id ? '更新成功' : '新增成功');
            closeModal();
            loadAllData();
        };

        window.deleteContact = async (id) => {
            if (!confirm('確定要刪除嗎？')) return;
            await apiRequest(`/contacts/${id}`, { method: 'DELETE' });
            showMessage('success', '刪除成功');
            loadAllData();
        };

        window.addEventListener('DOMContentLoaded', async () => {
            // 初始化所有圖標
            await new Promise(resolve => setTimeout(resolve, 100)); // 等待 Lucide 加載
            lucide.createIcons();
            await loadAllData();
        });
    </script>
</body>
</html>